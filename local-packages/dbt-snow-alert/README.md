<!-- markdownlint-disable no-inline-html no-alt-text ul-indent code-block-style -->
# Snowflake Alerts ‚ùÑÔ∏è

Alerting approach - adding first serves for Data Recency checks by leveraging [Sending Email Notifications](https://docs.snowflake.com/en/user-guide/email-stored-procedures) sending the notification into the Slack channel's email.

## Usage

Add a new step to the targeted dbt Cloud Job, it should be the last step, with the following command:

- For example in TBD job:

```bash
dbt run-operation TBD_alerts

# for a dry run
dbt run-operation TBD__alerts --args '{dry_run: true}'
```

## Production Readiness

## 1. Create a Snowflake User and get the email address verified

We need an associated Snowflake User that holds the Slack Channel's email address.

Login to Snowflake using this new user's credential and **get the email verification done** ‚ùó

üëâ Sample script for User creation:

```sql
use role securityadmin;
create or replace user user_slack_email_alert with
  password='<hidden>'
  email = '<channelname>-<hashstring>@<tbd>.slack.com';
```

## 2. Create the Notification Integration object

Make sure that the Notification Integration object gets created manually first using the `ACCOUNTADMIN` role.

Its script will be generated by `engine/snow_alert__create_or_get_resource` macro:

```bash
dbt run-operation snow_alert__create_or_get_resource --args '{create: true}'
```

üëâ Sample generated script:
  
```sql
use role accountadmin;

create or replace notification integration <YOUR NOTIFICATION INTEGRATION NAME>
  type = email
  enabled = true
  allowed_recipients = ('<hidden>@<hidden>.slack.com')
  comment = "PROD Notification Integration object used for <hidden> dbt project";
grant usage on integration <YOUR NOTIFICATION INTEGRATION NAME> to role role_transform_prod;
```

## 3. Decide to configure the alerts

All jobs can be found under the `jobs/` directory. Refers to the [Usage](#usage) section to find the dbt command, and configure it into the dbt Cloud Job.

In the future, if the email is changed, we're able to update the mailing list by using the dbt Cloud environment variable named `DBT_CLOUD_ALERT_EMAILS` - multiple values are split by comma.
